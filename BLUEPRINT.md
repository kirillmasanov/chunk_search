# AI Search Demo - Yandex Cloud Blueprint

## 1. Введение

**Название проекта:** AI Search Demo - Custom Chunks

**Описание задачи:**

AI Search Demo — это демонстрационное веб-приложение для показа преимуществ пользовательских чанков в Yandex Cloud AI Studio. Приложение сравнивает два подхода к чанкованию документов: автоматическое (платформа сама разбивает документ) и пользовательское (загрузка готовых чанков в формате JSONL).


**Основные сервисы Yandex Cloud:**
- **Yandex Cloud AI Studio** — платформа для работы с AI-моделями и инструментами, включающая:
  - **Vector Store API** — индексация данных и извлечение данных для RAG
  - **Files API** — загрузка, хранение и работа с файлами для RAG-сценариев
  - **Responses API** — генерация текста, вызов инструментов, получение структурированных ответов, реализация RAG-сценариев
  - **Model Gallery** — доступ к языковым моделям (в проекте используется qwen3-235b-a22b-fp8/latest)

**Цель и ожидаемый результат:**

После выполнения инструкций из этого документа вы получите работающее веб-приложение, которое:
- Демонстрирует разницу между автоматическим и пользовательским чанкованием
- Предоставляет удобный веб-интерфейс для работы с обоими режимами
- Использует RAG (Retrieval-Augmented Generation) для генерации ответов

---

## 2. Архитектура решения

### Описание архитектуры

Приложение построено на основе FastAPI и работает как веб-сервис с простой архитектурой. Пользователь взаимодействует с приложением через веб-интерфейс:

1. **Инициализация индексов**: Создание двух Vector Store (для автоматического и пользовательского чанкования)
2. **Загрузка данных**: Загрузка файлов с данными в соответствующие Vector Store
3. **Индексация**: Построение векторных индексов (автоматическое чанкование для режима A, готовые чанки для режима B)
4. **Поиск**: Пользователь вводит запрос, система находит релевантные чанки в выбранном режиме
5. **Генерация ответа**: Модель генерирует ответ на основе найденных чанков
6. **Результат**: Отображение ответа и найденных чанков с их score релевантности и кол-вом используемых токенов. 

### Компоненты системы

```
┌──────────────────────────────────────────────────────┐
│              Пользователь (Browser)                  │
└───────────────────────┬──────────────────────────────┘
                        │ HTTP
                        ▼
┌──────────────────────────────────────────────────────┐
│         Frontend (HTML/CSS/JavaScript)               │
│  • Выбор режима (A/B)                                │
│  • Ввод запроса                                      │
│  • Отображение результатов                           │
└───────────────────────┬──────────────────────────────┘
                        │ REST API
                        ▼
┌──────────────────────────────────────────────────────┐
│           Backend (FastAPI + Python)                 │
│  • Управление Vector Store                           │
│  • Загрузка файлов                                   │
│  • Поиск и RAG                                       │
└───────────────────────┬──────────────────────────────┘
                        │ OpenAI SDK
                        ▼
┌──────────────────────────────────────────────────────┐
│          Yandex Cloud AI Studio                      │
│                                                       │
│  ┌────────────────────────────────────────────────┐  │
│  │ Files API                                      │  │
│  │ • Загрузка файлов                              │  │
│  │ • Автоматическое/пользовательское чанкование   │  │
│  └────────────────────────────────────────────────┘  │
│                                                       │
│  ┌────────────────────────────────────────────────┐  │
│  │ Vector Store API                               │  │
│  │ • Индексация документов                        │  │
│  │ • Семантический поиск                          │  │
│  └────────────────────────────────────────────────┘  │
│                                                       │
│  ┌────────────────────────────────────────────────┐  │
│  │ Responses API + Model Gallery                  │  │
│  │ • Генерация ответов (RAG)                      │  │
│  │ • LLM-модель           │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
```

### Используемые сервисы Yandex Cloud

**Основной сервис:** Yandex Cloud AI Studio

**Компоненты AI Studio, используемые в проекте:**

| Компонент | Назначение | Необходимые роли |
|-----------|------------|------------------|
| **Files API** | Загрузка и хранение файлов | `ai.assistants.editor` |
| **Vector Store API** | Индексация документов и семантический поиск по векторным представлениям | `ai.assistants.editor` |
| **Responses API** | Генерация ответов на основе найденного контекста (RAG) | `ai.assistants.editor` |
| **Model Gallery** | Доступ к языковым моделям | `ai.languageModels.user` |

**Итоговые роли для сервисного аккаунта:**
- `ai.assistants.editor` — для работы с Files API, Vector Store API и Responses API
- `ai.languageModels.user` — для использования моделей из Model Gallery


### Особенности реализации

- Монолитная архитектура
- Асинхронная обработка запросов
- Поддержка двух режимов чанкования
- RAG для генерации ответов
- Готовая Docker-конфигурация

---

## 3. Подготовка окружения

### Системные требования

- **Python 3.11+**
- **uv** (менеджер пакетов Python)
- **Docker и Docker Compose** (опционально, для контейнеризации)

### Установка зависимостей

#### Вариант 1: Локальная установка с uv

```bash
# Установка uv (менеджер пакетов Python)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Добавление uv в PATH
echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# Клонирование репозитория
git clone https://github.com/kirillmasanov/chunk_search
cd chunk_search

# Установка зависимостей и создание виртуального окружения
uv sync

# Активация окружения
source .venv/bin/activate  # macOS/Linux

#### Вариант 2: Docker

```bash
# Клонирование репозитория
git clone https://github.com/kirillmasanov/chunk_search
cd chunk_search

# Docker автоматически установит все зависимости при сборке
```

#### Установка Docker (Ubuntu)

Если Docker еще не установлен на вашей системе Ubuntu, выполните следующие команды:

```bash
# Обновление списка пакетов
sudo apt-get update

# Установка необходимых пакетов
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# Добавление официального GPG ключа Docker
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# Добавление репозитория Docker
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Обновление списка пакетов
sudo apt-get update

# Установка Docker Engine, containerd и Docker Compose
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Добавление текущего пользователя в группу docker (чтобы не использовать sudo)
sudo usermod -aG docker $USER

# Применение изменений в группах (требуется перелогиниться или выполнить)
newgrp docker

# Проверка установки
docker --version
docker compose version
```

### Настройка Yandex Cloud CLI (опционально)

Для автоматизации создания ресурсов установите Yandex Cloud CLI:

```bash
# Установка yc CLI
curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash

# Инициализация и конфигурация
yc init
```

---

## 4. Развёртывание инфраструктуры

### 4.1. Создание сервисного аккаунта

#### Через веб-консоль:

1. Перейдите в [консоль Yandex Cloud](https://console.cloud.yandex.ru/)
2. Выберите ваш каталог
3. Перейдите в раздел "Сервисные аккаунты"
4. Нажмите "Создать сервисный аккаунт"
5. Укажите имя, например, `ai-search-demo-sa`
6. Добавьте описание, например, "Service account for AI Search Demo"

#### Через CLI:

```bash
# Создание сервисного аккаунта
yc iam service-account create \
  --name ai-search-demo-sa \
  --description "Service account for AI Search Demo"

# Получение ID созданного аккаунта
SA_ID=$(yc iam service-account get ai-search-demo-sa --format json | jq -r '.id')
echo "Service Account ID: $SA_ID"
```

### 4.2. Назначение ролей

Сервисному аккаунту необходимы роли для работы с AI Studio:

#### Через веб-консоль:

1. Откройте страницу каталога
2. Перейдите на вкладку "Права доступа"
3. Нажмите "Назначить роли"
4. Выберите сервисный аккаунт `ai-search-demo-sa`
5. Добавьте роли:
   - `ai.assistants.editor`
   - `ai.languageModels.user`

#### Через CLI:

```bash
# Получение FOLDER_ID
FOLDER_ID=$(yc config get folder-id)

# Назначение ролей для работы с AI Studio
yc resource-manager folder add-access-binding $FOLDER_ID \
  --role ai.assistants.editor \
  --service-account-id $SA_ID

yc resource-manager folder add-access-binding $FOLDER_ID \
  --role ai.languageModels.user \
  --service-account-id $SA_ID
```

### 4.3. Создание API ключа

#### Через веб-консоль:

1. Откройте страницу сервисного аккаунта
2. Перейдите на вкладку "API-ключи"
3. Нажмите "Создать API-ключ"
4. Укажите область действия: `yc.ai.foundationModels.execute`
5. **Важно:** Скопируйте ключ (он показывается только один раз!)

#### Через CLI:

```bash
# Создание API-ключа с областью действия для Foundation Models
API_KEY=$(yc iam api-key create \
  --service-account-id $SA_ID \
  --scopes yc.ai.foundationModels.execute \
  --format json | jq -r '.secret')
echo "API Key: $API_KEY"
```

### 4.4. Настройка переменных окружения

Создайте файл `.env` в корне проекта на основе `.env.example`:

```bash
# Скопировать образец
cp .env.example .env

# Отредактировать файл и заменить значения
nano .env  # или vim .env
```

**Автоматическое создание через CLI:**

```bash
FOLDER_ID=$(yc config get folder-id)
SA_ID=$(yc iam service-account get ai-search-demo-sa --format json | jq -r '.id')
API_KEY=$(yc iam api-key create \
  --service-account-id $SA_ID \
  --scopes yc.ai.foundationModels.execute \
  --format json | jq -r '.secret')

# Создать .env в корне проекта
cat > .env << EOF
YANDEX_API_KEY=$API_KEY
YANDEX_FOLDER_ID=$FOLDER_ID
YANDEX_CLOUD_MODEL=qwen3-235b-a22b-fp8/latest
SERVER_PORT=8000
EOF

echo "Файл .env создан успешно в корне проекта"
```

---

## 5. Запуск приложения

### Вариант 1: Запуск с использованием Python

```bash
# Из корня проекта
# Запуск приложения через uv
uv run uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

Приложение будет доступно на порту **8000**.


### Вариант 2: Запуск с использованием Docker

**Важно:** Перед запуском Docker убедитесь, что вы создали `.env` файл в корне проекта (см. раздел 4.4 "Настройка переменных окружения").

```bash
# Сборка и запуск контейнера
docker compose up -d

# Просмотр логов
docker compose logs -f

# Проверка статуса
docker compose ps
```

**Перезапуск после изменений:**

Если вы внесли изменения в код или Dockerfile, перезапустите контейнер:

```bash
# Остановить контейнер
docker compose down

# Пересобрать образ без использования кэша
docker compose build --no-cache

# Запустить контейнер
docker compose up -d

# Или короткая версия (пересборка и запуск одной командой)
docker compose up -d --build --force-recreate
```

Приложение будет доступно на порту **8000** (или на порту, указанном в переменной `SERVER_PORT`).

### Проверка работоспособности

Откройте в браузере:
- **При локальном запуске:** `http://localhost:8000`
- **При запуске на виртуальной машине:** `http://<IP-адрес-ВМ>:8000`

**Примечание:** При развертывании на виртуальной машине в Yandex Cloud убедитесь, что:
- В группе безопасности открыт соответствующий порт
- У виртуальной машины есть публичный IP-адрес (если требуется доступ из интернета)

---

## 6. Тестирование решения

### 6.1. Инициализация индексов

1. Откройте приложение в браузере (см. раздел "Проверка работоспособности")
2. (Опционально) Настройте максимальное количество результатов поиска (по умолчанию 3)
3. Нажмите кнопку "Загрузить данные и создать индексы"
4. Дождитесь завершения процесса (1-2 минуты)

### 6.2. Тестирование режима A (Автоматическое чанкование)

1. Выберите "Режим A" в интерфейсе
2. Введите тестовый вопрос: **"Какие операционные системы поддерживаются?"**
3. Нажмите "Найти"
4. Изучите результаты:
   - Ответ модели
   - Найденные чанки с их score релевантности

### 6.3. Тестирование режима B (Пользовательские чанки)

1. Выберите "Режим B" в интерфейсе
2. Введите тот же вопрос: **"Какие операционные системы поддерживаются?"**
3. Нажмите "Найти"
4. Сравните результаты с режимом A:
   - Score релевантности должен быть выше
   - Количество использованных токенов меньше
   
---

## 7. Результаты и выводы

### Ожидаемый результат

После успешного тестирования вы увидите явную разницу между двумя режимами:

**Режим A (Автоматическое чанкование):**
- Score релевантности: обычно 0.6-0.8
- Вопрос и ответ могут быть разделены
- Ответ модели может быть неполным

**Режим B (Пользовательские чанки):**
- Score релевантности: обычно 0.85-0.95
- Вопрос и ответ всегда вместе
- Ответ модели более точный и полный

### Преимущества пользовательских чанков

- **Сохранение логической целостности**: Вопрос и ответ остаются вместе
- **Более высокий score релевантности**: Улучшение на 15-30%
- **Более точные ответы модели**: Полный контекст для генерации
- **Экономия токенов**: Меньший расход токенов за счет:
  - Отсутствия дублирования контекста между чанками
  - Более точного попадания в релевантные фрагменты
  - Уменьшения количества необходимых чанков для полного ответа
- **Контроль над структурой**: Вы определяете границы чанков
- **Гибкость**: Адаптация под специфику данных

### Применение в реальных проектах

Пользовательские чанки особенно полезны для:

1. **FAQ системы**: Каждый Q&A — отдельный чанк
2. **Юридические документы**: Каждая статья — отдельный чанк
3. **Техническая документация**: Каждый раздел — отдельный чанк
4. **Код**: Каждая функция/класс — отдельный чанк
5. **Продуктовые каталоги**: Каждый товар — отдельный чанк

---

## 8. Очистка ресурсов

### Остановка приложения

**Локальный запуск:**
```bash
# Остановка приложения (Ctrl+C в терминале)
```

**Docker:**
```bash
# Остановка контейнера
docker compose down

# Полная очистка (включая volumes)
docker compose down -v
```

### Удаление Vector Stores и файлов

Через веб-интерфейс:
1. Нажмите кнопку "Удалить индексы и файлы"
2. Подтвердите действие в диалоговом окне
3. Дождитесь завершения удаления

Через API:
```bash
curl -X POST http://localhost:8000/api/reset
```

Эта операция удаляет:
- Оба Vector Store (auto и chunks)
- Все загруженные файлы из Files API

### Удаление сервисного аккаунта (опционально)

```bash
# Получение ID сервисного аккаунта
SA_ID=$(yc iam service-account get ai-search-demo-sa --format json | jq -r '.id')

# Удаление API ключей
yc iam api-key list --service-account-id $SA_ID --format json | \
  jq -r '.[].id' | \
  xargs -I {} yc iam api-key delete {}

# Удаление сервисного аккаунта
yc iam service-account delete $SA_ID
```

---

## 9. Полезные ссылки

### Документация Yandex Cloud

- [Yandex Cloud AI Studio](https://yandex.cloud/ru/docs/ai-studio/)
- [Vector Store API](https://yandex.cloud/ru/docs/ai-studio/concepts/search/vectorstore)
- [Создание агента с чанками](https://yandex.cloud/ru/docs/ai-studio/operations/agents/create-prechunked-search-agent)
- [Управление доступом в Yandex Cloud](https://cloud.yandex.ru/docs/iam/)
- [Сервисные аккаунты](https://cloud.yandex.ru/docs/iam/concepts/users/service-accounts)

### Репозиторий проекта

- [GitHub: chunk_search](https://github.com/kirillmasanov/chunk_search)

### Дополнительная документация

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Docker Documentation](https://docs.docker.com/)
- [OpenAI SDK Documentation](https://platform.openai.com/docs/api-reference)

---

## Примечания

### Рекомендации

- Используйте пользовательские чанки для структурированных данных (FAQ, документация, каталоги)
- Для неструктурированного текста автоматическое чанкование может быть достаточным

### Стоимость использования

Стоимость использования зависит от:
- Количества поисковых запросов
- Использования модели для генерации ответов

Актуальные цены см. на странице тарифов [Yandex Cloud AI Studio](https://yandex.cloud/ru/docs/ai-studio/pricing).